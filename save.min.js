(async()=>{const e=document.createElement("style");e.textContent="\n   :root {\n      --text-color: #000; \n      --background-color: #fff; \n      --input-border-color: #ccc;\n      --button-background-color: #007bff;\n      --button-text-color: #fff;\n      --button-hover-background-color: #0056b3;\n      --description-color: #666;\n      --saved-indicator-color: green;\n    }\n\n    \n    @media (prefers-color-scheme: dark) {\n      :root {\n        --text-color: #fff; \n        --background-color: #333; \n        --input-border-color: #555;\n        --button-background-color: #0056b3; \n        --description-color: #aaa;\n      }\n    }\n\n    .pinecone-modal {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.5);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 1000;\n      overflow: auto;\n    }\n\n    .pinecone-modal-content {\n      background-color: var(--background-color);\n      padding: 20px 25px 25px 25px; \n      border-radius: 8px;\n      width: 80%;\n      max-width: 500px;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      display: flex; \n      flex-direction: column; \n      justify-content: space-between; \n    }\n\n    .pinecone-config-inputs {\n      \n    }\n\n    .pinecone-input-wrapper {\n        margin-bottom: 15px; \n    }\n\n    .pinecone-input-label {\n      display: block;\n      margin-bottom: 5px;\n      color: var(--text-color);\n      font-weight: bold; \n    }\n\n    .pinecone-input-field {\n      width: 100%;\n      padding: 8px;\n      margin-bottom: 10px;\n      border: 1px solid var(--input-border-color);\n      border-radius: 4px;\n      box-sizing: border-box;\n      color: var(--text-color);\n      background-color: var(--background-color); \n    }\n    .pinecone-input-field::placeholder {\n        color: #999;\n    }\n\n    .pinecone-input-description {\n      font-size: 0.8em;\n      color: var(--description-color);\n      margin-bottom: 10px;\n    }\n\n    .pinecone-saved-indicator {\n      margin-left: 10px;\n      color: var(--saved-indicator-color);\n    }\n\n    .pinecone-button {\n      padding: 10px 15px;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      transition: background-color 0.3s ease;\n      color: var(--button-text-color);\n    }\n\n    .pinecone-save-button {\n      background-color: var(--button-background-color);\n    }\n\n    .pinecone-save-button:hover {\n      background-color: var(--button-hover-background-color);\n    }\n\n    .pinecone-close-button {\n      background-color: #6c757d;\n      margin-left: 10px;\n    }\n\n    .pinecone-close-button:hover {\n      background-color: #545b62;\n    }\n\n    \n    @media (max-width: 768px) {\n      .pinecone-modal-content {\n        width: 95%; \n      }\n      .pinecone-input-label {\n          font-weight: normal; \n      }\n    }\n\n    \n    .pinecone-button-container {\n        display: flex;\n        align-items: center; \n        justify-content: flex-start; \n        \n    }\n  ",document.head.appendChild(e);const n=function(e,n){let t;return function(...o){const a=this;clearTimeout(t),t=setTimeout((()=>e.apply(a,o)),n)}}((function(){const e=document.getElementById("pinecone-host").value,n=document.getElementById("pinecone-api-key").value,t=document.getElementById("pinecone-namespace").value,o=document.getElementById("openai-model").value;let a=document.getElementById("embedding-dimension").value;a||(a="");const i=document.getElementById("openai-api-key").value;localStorage.setItem("saveExtension-pinecone-host",e),localStorage.setItem("saveExtension-pinecone-api-key",n),localStorage.setItem("saveExtension-pinecone-namespace",t),localStorage.setItem("saveExtension-openai-model",o),localStorage.setItem("saveExtension-embedding-dimension",a),localStorage.setItem("saveExtension-pinecone-openai-api-key",i);const c=document.getElementById("config-saved-indicator");c&&(c.textContent="Saved!",c.style.color="green",setTimeout((()=>{c.textContent=""}),2e3))}),500);function t(){let e=document.getElementById("pinecone-config-modal");e&&e.remove();let t=document.createElement("div");t.id="pinecone-config-modal",t.className="pinecone-modal";const i=document.createElement("div");i.className="pinecone-modal-content";const c=document.createElement("div");function r(e,t,o="text",a="",i=!0,r="",s=""){const l=document.createElement("label");l.textContent=e,l.htmlFor=t,l.className="pinecone-input-label";const d=document.createElement("input");d.type=o,d.id=t,d.name=t,d.placeholder=a,d.required=i,d.value=r,d.className="pinecone-input-field",d.addEventListener("input",n);const p=document.createElement("div");if(p.className="pinecone-input-wrapper",p.appendChild(l),p.appendChild(d),s){const e=document.createElement("p");e.textContent=s,e.className="pinecone-input-description",p.appendChild(e)}c.appendChild(p)}c.id="pinecone-config-inputs",c.className="pinecone-config-inputs",r("Pinecone Index Host URL:","pinecone-host","text","your-index-host.pinecone.io",!0,localStorage.getItem("saveExtension-pinecone-host")||"","The URL of your Pinecone index."),r("Pinecone API Key:","pinecone-api-key","password","Your Pinecone API Key",!0,localStorage.getItem("saveExtension-pinecone-api-key")||"","Your Pinecone API key."),r("Namespace:","pinecone-namespace","text","chat01",!0,localStorage.getItem("saveExtension-pinecone-namespace")||"chat01","Specify a namespace for this chat. Use a unique namespace to prevent data conflicts."),r("OpenAI Embedding Model:","openai-model","text","text-embedding-3-small",!0,localStorage.getItem("saveExtension-openai-model")||"text-embedding-3-small","The OpenAI embedding model."),r("Embedding Dimension (Optional):","embedding-dimension","number","",!1,localStorage.getItem("saveExtension-embedding-dimension")||"","The dimension of the embedding vector."),r("OpenAI API Key:","openai-api-key","password","Your OpenAI API Key",!0,localStorage.getItem("saveExtension-pinecone-openai-api-key")||localStorage.getItem("TM_useAPIKey")||"","Your OpenAI API key.");const s=document.createElement("span");s.id="config-saved-indicator",s.className="pinecone-saved-indicator",c.appendChild(s);const l=document.createElement("div");l.className="pinecone-button-container";const d=document.createElement("button");d.type="button",d.className="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-default transition-colors",d.innerHTML='<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" fill-rule="evenodd" class="w-4 h-4 mr-2" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h360c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H184V184h656v320c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V144c0-17.7-14.3-32-32-32ZM770.87 824.869l-52.2 52.2c-4.7 4.7-1.9 12.8 4.7 13.6l179.4 21c5.1.6 9.5-3.7 8.9-8.9l-21-179.4c-.8-6.6-8.9-9.4-13.6-4.7l-52.4 52.4-256.2-256.2c-3.1-3.1-8.2-3.1-11.3 0l-42.4 42.4c-3.1 3.1-3.1 8.2 0 11.3l256.1 256.3Z" transform="matrix(1 0 0 -1 0 1024)"></path></svg><span>Save Chat to Pinecone</span>',d.onclick=()=>{!async function(){try{const e=window.location.hash.match(/#chat=([^&]+)/);if(!e||!e[1])return void alert("No chat selected.");const n=e[1],t=await async function(){return new Promise(((e,n)=>{const t="keyval-store",o=indexedDB.open(t);o.onsuccess=()=>{const n=o.result;e(n)},o.onerror=()=>{n(o.error)}}))}(),i=await async function(e,n){return new Promise(((t,o)=>{const a="keyval",i=e.transaction([a],"readonly"),c=i.objectStore(a),r=`CHAT_${n}`,s=c.get(r);s.onsuccess=()=>{const e=s.result;e?t(e):o(new Error("Chat not found."))},s.onerror=()=>{o(s.error)},i.oncomplete=()=>{e.close()}}))}(t,n),c=i.chatID||i.id||"",r=i.chatTitle||i.title||"Untitled Chat",s=i.messages||i.conversation||[],l={chat_id:c,chatTitle:r,messages:s.map(((e,n)=>({message_number:n,content:e.content,createdAt:e.createdAt,role:e.role,chat_id:c})))},d=await async function(e){try{await o();const n=localStorage.getItem("saveExtension-pinecone-openai-api-key"),t=localStorage.getItem("saveExtension-openai-model"),i=localStorage.getItem("saveExtension-embedding-dimension");if(!n||!t)throw new Error("OpenAI API key and model must be configured.");const c=function(e){switch(e){case"text-embedding-ada-002":return"cl100k_base";case"text-embedding-3-small":case"text-embedding-3-large":return"o200k_base";default:throw new Error(`Unsupported embedding model: ${e}`)}}(t),r=await async function(e){const n=await fetch(`https://tiktoken.pages.dev/js/${e}.json`);if(!n.ok)throw new Error(`Failed to fetch encoding: ${n.status} ${n.statusText}`);return await n.json()}(c),{Tiktoken:s}=await import("https://esm.sh/js-tiktoken@1.0.19/lite"),l=new s(r),d=e.messages,p=[],m=8192;let u=[],g=0;for(const e of d){const o="string"==typeof e.content?e.content:JSON.stringify(e.content),c=l.encode(o).length;if(g+c>m){const e=await a(u,n,t,i);p.push(...e),u=[],g=0}u.push({...e,content:o}),g+=c}if(u.length>0){const e=await a(u,n,t,i);p.push(...e)}return p}catch(e){throw e}}(l);await async function(e){try{let n=localStorage.getItem("saveExtension-pinecone-host");const t=localStorage.getItem("saveExtension-pinecone-api-key"),o=localStorage.getItem("saveExtension-pinecone-namespace");if(!n||!t||!o)throw new Error("Pinecone host, API key, and namespace must be configured.");n=n.replace(/^https?:\/\//,"");const a=`https://${n}/vectors/upsert`,i=1e3;for(let n=0;n<e.length;n+=i){const c={vectors:e.slice(n,n+i),namespace:o},r=await fetch(a,{method:"POST",headers:{"Api-Key":t,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!r.ok){const e=await r.json();throw new Error(`Pinecone API error: ${r.status} ${r.statusText} - ${JSON.stringify(e)}`)}}alert("Chat data saved to Pinecone successfully!")}catch(e){console.error("Error in upsertToPinecone:",e),alert("An error occurred while upserting data to Pinecone: "+e.message)}}(d)}catch(e){console.error("Error in getAndProcessChatData:",e),alert("An error occurred while processing and saving chat data: "+e.message)}}(),t.remove()},l.appendChild(d);const p=document.createElement("button");p.type="button",p.className="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:bg-gray-400 disabled:cursor-default transition-colors ml-2",p.textContent="Close",p.onclick=()=>{t.remove()},l.appendChild(p),c.appendChild(l),i.appendChild(c),t.appendChild(i),document.body.appendChild(t)}async function o(){return new Promise(((e,n)=>{if("undefined"!=typeof Tiktoken)return void e();if(document.getElementById("tiktoken-script"))e();else{const t=document.createElement("script");t.src="https://unpkg.com/js-tiktoken@1.0.19/lite.js",t.id="tiktoken-script",t.onload=()=>{e()},t.onerror=()=>{n(new Error("Failed to load js-tiktoken library."))},document.head.appendChild(t)}}))}async function a(e,n,t,o){const a={input:e.map((e=>{let n="string"==typeof e.content?e.content:JSON.stringify(e.content);return""===n.trim()&&(n=" "),n})),model:t};o&&(a.dimensions=parseInt(o,10));const i=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){const e=await i.json();throw new Error(`OpenAI API error: ${i.status} ${i.statusText} - ${JSON.stringify(e)}`)}return(await i.json()).data.map(((n,t)=>{const o=e[n.index];return{id:`${o.chat_id}-message${o.message_number}`,values:n.embedding,metadata:{chat_id:o.chat_id,message_number:o.message_number,role:o.role,content:o.content}}}))}!function(){const e=document.querySelector('button[data-element-id="workspace-tab-settings"]');if(!e)return void console.warn("Settings button not found.");const n=e.closest("div");if(!n)return void console.warn("Button container not found.");const o=document.createElement("button");o.setAttribute("data-element-id","workspace-tab-save-to-pinecone"),o.style.color=window.getComputedStyle(n).color,o.style.fontFamily=window.getComputedStyle(n).fontFamily,o.style.alignItems="center",o.className=e.className;const a=document.createElement("span");a.className=e.querySelector("span").className;const i=document.createElement("span"),c=e.querySelector("span > svg");i.className=c?c.className:"w-4 h-4 flex-shrink-0",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 64 64" fill="currentColor" class="w-4 h-4 flex-shrink-0"><path d="M31 48V3M16 20L31 3l15 16" stroke-width="4" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none"/><path d="M8 46v16h46V46" stroke-width="4" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none"/></svg>';const r=document.createElement("span"),s=e.querySelector("span > span");r.className=s?s.className:"font-normal self-stretch text-center text-xs leading-4 md:leading-none",r.textContent="Save",a.appendChild(i),a.appendChild(r),o.appendChild(a),o.onclick=()=>{t()},e.parentElement.insertBefore(o,e.nextSibling)}()})();
